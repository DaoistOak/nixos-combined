#!/usr/bin/env bash

# Updt: Comprehensive NixOS & Home-Manager Update Script
# Updates flake inputs, rebuilds both system and user configurations

set -e  # Exit on any error

# Configuration
FLAKE_PATH="$HOME/.config/nixos"
NIXOS_HOST="Overlord"
HOME_USER="zeph"
SUCCESS_SOUND="/run/current-system/sw/share/sounds/freedesktop/stereo/complete.oga"
ERROR_SOUND="/run/current-system/sw/share/sounds/freedesktop/stereo/dialog-error.oga"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}‚Ñπ${NC} $1"
}

log_success() {
    echo -e "${GREEN}‚úÖ${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}‚ö†${NC} $1"
}

log_error() {
    echo -e "${RED}‚ùå${NC} $1"
}

# Notification function
notify() {
    local title="$1"
    local message="$2"
    local urgency="${3:-normal}"

    if command -v notify-send &> /dev/null; then
        notify-send -u "$urgency" "$title" "$message"
    fi
}

# Sound function
play_sound() {
    local sound_file="$1"
    if [[ -f "$sound_file" ]] && command -v pw-play &> /dev/null; then
        pw-play "$sound_file" 2>/dev/null || true
    fi
}

# Check if we're in the right directory
check_directory() {
    if [[ ! -d "$FLAKE_PATH" ]]; then
        log_error "Flake directory not found: $FLAKE_PATH"
        exit 1
    fi

    cd "$FLAKE_PATH" || {
        log_error "Cannot cd into $FLAKE_PATH"
        exit 1
    }
}

# Check for uncommitted changes
check_git_status() {
    if [[ -n $(git status --porcelain) ]]; then
        log_warning "Uncommitted changes detected"
        echo "üìÑ Opening LazyGit to review changes..."
        sleep 2

        if command -v lazygit &> /dev/null; then
            lazygit
        else
            git status
            echo "Press Enter to continue or Ctrl+C to abort..."
            read -r
        fi
    fi
}

# Update flake inputs
update_flake_inputs() {
    log_info "Updating flake inputs..."
    if nix flake update; then
        log_success "Flake inputs updated"
    else
        log_error "Failed to update flake inputs"
        return 1
    fi
}

# Build NixOS system
build_nixos() {
    log_info "Building NixOS system ($NIXOS_HOST)..."

    if nh os build .#nixosConfigurations."$NIXOS_HOST"; then
        log_success "NixOS build successful"
        return 0
    else
        log_error "NixOS build failed"
        return 1
    fi
}

# Build home-manager configuration
build_home_manager() {
    log_info "Building home-manager configuration ($HOME_USER)..."

    if home-manager build --flake .#"$HOME_USER"; then
        log_success "Home-manager build successful"
        return 0
    else
        log_error "Home-manager build failed"
        return 1
    fi
}

# Switch to new NixOS system
switch_nixos() {
    log_info "Switching to new NixOS system..."

    if nh os switch .#nixosConfigurations."$NIXOS_HOST"; then
        log_success "NixOS switch successful"
        return 0
    else
        log_error "NixOS switch failed"
        return 1
    fi
}

# Switch to new home-manager configuration
switch_home_manager() {
    log_info "Switching to new home-manager configuration..."

    if home-manager switch -b backup --flake .#"$HOME_USER"; then
        log_success "Home-manager switch successful"
        return 0
    else
        log_error "Home-manager switch failed"
        return 1
    fi
}

# Commit changes
commit_changes() {
    log_info "Committing changes to git..."

    # Check if there are actually changes to commit
    if [[ -z $(git diff --cached --name-only) ]] && [[ -z $(git diff --name-only) ]]; then
        log_info "No changes to commit"
        return 0
    fi

    git add -A

    # Create a meaningful commit message
    local commit_msg="Update: $(date '+%Y-%m-%d %H:%M:%S')"
    local changed_files=$(git diff --cached --name-only | wc -l)
    commit_msg="$commit_msg ($changed_files files changed)"

    if git commit -m "$commit_msg"; then
        log_success "Changes committed: $commit_msg"
    else
        log_warning "Failed to commit changes"
    fi
}

# Push changes
push_changes() {
    log_info "Pushing changes to remote..."

    if git push; then
        log_success "Changes pushed"
    else
        log_error "Failed to push changes"
    fi
}

# Main update function
main() {
    # Pre-flight checks
    check_directory
    check_git_status

    # Clear screen
    clear

    # Options menu
    echo -e "${BOLD}${BLUE}üöÄ NixOS Update Script${NC}"
    echo -e "${BLUE}======================${NC}"
    echo -e "${BOLD}Select an option:${NC}"
    echo -e "1. ${GREEN}Update All${NC}           - Flake + System + Home-Manager"
    echo -e "2. ${YELLOW}Update Flake Only${NC}    - Update flake inputs only"
    echo -e "3. ${RED}Update System Only${NC}    - NixOS system only"
    echo -e "4. ${BLUE}Update Home-Manager Only${NC} - Home-manager only"
    echo -e "5. ${GREEN}Git Push${NC}             - Push changes to remote"
    echo -e "6. ${RED}Exit${NC}"
    echo
    read -p "Enter choice (1-6): " choice
    case $choice in
            1)
                echo -e "${BOLD}${GREEN}üöÄ Starting comprehensive NixOS & Home-Manager update...${NC}"
                echo -e "${GREEN}==================================================${NC}"

                # Ask for sudo password upfront
                log_info "Requesting sudo access..."
                sudo -v

                # Update phase
                update_flake_inputs

                # Build phase (dry run)
                echo
                log_info "Build Phase (Testing configurations)..."
                echo "---------------------------------------"

                if ! build_nixos; then
                    notify "‚ùå Build Failed" "NixOS build failed. Check terminal for details." "critical"
                    play_sound "$ERROR_SOUND"
                    exit 1
                fi

                if ! build_home_manager; then
                    notify "‚ùå Build Failed" "Home-manager build failed. Check terminal for details." "critical"
                    play_sound "$ERROR_SOUND"
                    exit 1
                fi

                # Switch phase (actual application)
                echo
                log_info "Switch Phase (Applying configurations)..."
                echo "------------------------------------------"

                if ! switch_nixos; then
                    notify "‚ùå Switch Failed" "NixOS switch failed. System may be in inconsistent state." "critical"
                    play_sound "$ERROR_SOUND"
                    exit 1
                fi

                if ! switch_home_manager; then
                    notify "‚ùå Switch Failed" "Home-manager switch failed. User configuration may be inconsistent." "critical"
                    play_sound "$ERROR_SOUND"
                    exit 1
                fi

                # Post-update tasks
                echo
                log_info "Post-update tasks..."
                commit_changes

                # Success notification
                echo
                log_success "üéâ Update completed successfully!"
                log_success "Both NixOS system and home-manager configurations updated"

                notify "‚úÖ Update Complete" "NixOS and Home-Manager updated successfully!"
                play_sound "$SUCCESS_SOUND"
                ;;
            2)
                log_info "Updating flake only..."
                update_flake_inputs
                commit_changes
                ;;
            3)
                log_info "Updating system only..."
                log_info "Requesting sudo access..."
                sudo -v
                if ! build_nixos; then
                    notify "‚ùå Build Failed" "NixOS build failed. Check terminal for details." "critical"
                    play_sound "$ERROR_SOUND"
                    exit 1
                fi
                if ! switch_nixos; then
                    notify "‚ùå Switch Failed" "NixOS switch failed. System may be in inconsistent state." "critical"
                    play_sound "$ERROR_SOUND"
                    exit 1
                fi
                commit_changes
                ;;
            4)
                log_info "Updating home-manager only..."
                if ! build_home_manager; then
                    notify "‚ùå Build Failed" "Home-manager build failed. Check terminal for details." "critical"
                    play_sound "$ERROR_SOUND"
                    exit 1
                fi
                if ! switch_home_manager; then
                    notify "‚ùå Switch Failed" "Home-manager switch failed. User configuration may be inconsistent." "critical"
                    play_sound "$ERROR_SOUND"
                    exit 1
                fi
                commit_changes
                ;;
            5)
                push_changes
                ;;
            6)
                exit 0
                ;;
            *) echo -e "${RED}Invalid option $choice${NC}";;
        esac
}

# Run main function
main "$@"